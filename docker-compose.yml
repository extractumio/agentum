services:
  agentum-api:
    image: agentum:${AGENTUM_IMAGE_TAG:-latest}
    build: .
    command:
      - python
      - -m
      - uvicorn
      - src.api.main:app
      - --host=0.0.0.0
      - --port=40080
    environment:
      AGENTUM_ROOT: "/"
      PYTHONPATH: "/"
    volumes:
      - ./config:/config
      - ./data:/data
      - ./logs:/logs
      - ./src:/src
      - ./sessions:/sessions
      - ./prompts:/prompts:ro
      - ./skills:/skills:ro
      - ./tools:/tools:ro
      - ./tests:/tests:ro  # Tests mounted read-only for ./deploy.sh test
    ports:
      - "${AGENTUM_API_PORT:-40080}:40080"
    # Security configuration for bwrap sandbox
    # SYS_ADMIN is required for namespace operations (--unshare-pid, etc.)
    cap_add:
      - SYS_ADMIN
    security_opt:
      # Prevent privilege escalation inside container
      - no-new-privileges:true
    # Note: apparmor:unconfined and seccomp:unconfined removed
    # The agent-level bwrap sandbox provides isolation instead

  agentum-web:
    image: agentum:${AGENTUM_IMAGE_TAG:-latest}
    build: .
    entrypoint: ["/entrypoint-web.sh"]
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "50080"]
    working_dir: /src/web_terminal_client
    environment:
      AGENTUM_ROOT: "/"
      PYTHONPATH: "/"
      AGENTUM_WEB_PORT: "50080"
    volumes:
      - ./config:/config
      - ./logs:/logs
      - ./src:/src
      - web_node_modules:/src/web_terminal_client/node_modules
    ports:
      - "${AGENTUM_WEB_PORT:-50080}:50080"
    depends_on:
      - agentum-api
      - redis

  redis:
    image: redis:7-alpine
    command:
      - redis-server
      - --save
      - ""
      - --appendonly
      - "no"
    ports:
      - "127.0.0.1:46379:6379"

volumes:
  web_node_modules:
